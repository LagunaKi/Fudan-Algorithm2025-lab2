# DNA序列复杂比对工具（锚点链式比对）

## 功能简介
本项目实现了基于minimizer稀疏化kmer哈希、锚点合并、DP最长无重叠链、gap区间Smith-Waterman局部比对的DNA序列比对算法，适用于复杂变异场景。

## 主要特性
- 支持大规模DNA序列的高效比对
- 能识别插入、删除、突变、移位、倒位等多种变异
- 采用minimizer稀疏化+锚点链式结构，gap区间自动局部比对
- 主链自动识别倒位（逆转）突变，且保证query/ref区间无重叠
- 匹配区间自动合并，输出唯一、无重叠的区间列表

## 目录结构
```
src/
  dna_matcher.py  # 主算法实现
  __main__.py     # 命令行入口
README.md         # 项目说明
```

## 用法
假设有input.txt：
```bash
python -m src input.txt
```
输出格式为一个中括号包裹的区间列表：
```
[(query_start, query_end, ref_start, ref_end), ...]
```

## 算法详细流程说明

### 1. 多尺度k-mer锚点提取（支持倒位）
- 对query的正向和反向互补序列，采用多尺度k-mer哈希（minhash）在reference中查找完全匹配的锚点（anchor）。
- k值自适应递减，优先提取长锚点，短k仅在未被覆盖区域补充。
- 每个锚点记录其在query、reference中的起始位置、长度和方向（正向/反向）。

### 2. 锚点链式DP主链提取
- 将所有锚点视为节点，构建有向无环图（DAG），边表示锚点间可达且无重叠。
- 用动态规划（DP）寻找query/ref区间均无重叠、得分最高的主链（可自动跨越倒位片段）。
- DP转移时允许方向切换（正向↔反向），但区间顺序和无重叠性必须满足。

### 3. 主链区间合并与模糊延伸
- 对DP主链上的区间，采用自带的合并逻辑（区分正向/反向），将相邻、可合并的区间合并为更长区间。
- 合并后的每个主链区间，自动向两端延伸，**允许少量错配**（SNP），只要延伸后edit distance/区间长度不超过可调参数`ex_max_edit_ratio`（如0.1）即可。
- 延伸时严格保证query区间无重叠，且正反向区分处理。
- **反向匹配区间的延伸方式**：若区间(q0, q1, r0, r1, strand=-1)，则q[i]应比对ref[r1-(i-q0)]。向左延伸时q0-1, r1+1；向右延伸时q1+1, r0-1。edit distance计算时自动采用这种一一映射。

### 4. 匹配区间输出
- 所有主链区间经合并和延伸后，自动去重、排序，输出唯一、无重叠的区间列表。
- 区间方向信息通过strand标记，输出格式与评分函数完全兼容。

### 5. 参数可调与自动化调优
- 支持包括`max_gap`、`alpha`、`gamma`、`bonus`、`slope_eps`、`min_k`、`k_ratio`、`ex_max_edit_ratio`等多项参数，均可通过命令行或Optuna自动调参。
- `ex_max_edit_ratio`控制主链区间延伸时允许的最大edit distance比例，提升区间覆盖和得分。

### 6. 结果解读
- 输出为[(q_start, q_end, r_start, r_end), ...]，整体用中括号包裹。
- 若q_start < q_end，表示正向匹配；若q_start > q_end，表示倒位（逆转）匹配。
- 每个query/ref区间只会在主链中出现一次，且区间无重叠。

---

**备注：**
- gap区间的局部比对（如Smith-Waterman）可按需补充，但主链区间已能高效覆盖大部分得分区域。
- 所有流程均为纯Python实现，无需外部C/C++库，便于移植和调优。
- 输出格式与打分函数完全兼容，可直接用于自动评测和可视化。 


## 运行结果

python grade.py --input input2.txt
请输入区间答案（如[(0, 299, 0, 299), ...]）:
[(0, 296, 0, 296), (297, 399, 397, 499), (400, 494, 505, 599), (495, 693, 595, 793), (694, 767, 694, 767), (768, 798, 618, 648), (799, 912, 699, 812), (913, 999, 700, 786), (1000, 1199, 700, 899), (1200, 1299, 900, 999), (1300, 1401, 900, 1001), (1402, 1499, 402, 499), (1500, 1599, 1000, 1099), (1600, 1693, 1300, 1393), (1694, 1806, 1194, 1306), (1807, 1891, 1107, 1191), (1892, 2010, 1392, 1510), (2011, 2020, 39, 48), (2274, 2499, 1474, 1699)]
Score: 2096


